<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Admin ‚Äì Qu·∫£n l√Ω t√†i s·∫£n</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="bg-light">

<!-- ===== NAVBAR ===== -->
<nav class="navbar navbar-dark bg-dark">
  <div class="container">
    <span class="navbar-brand fw-bold">Admin ‚Äì Qu·∫£n l√Ω t√†i s·∫£n</span>
    <a href="dashboard.html" class="btn btn-light btn-sm">‚Üê Dashboard</a>
  </div>
</nav>

<div class="container py-4">

  <!-- ===== FORM ===== -->
  <div class="card p-4 mb-4">
    <h5 class="fw-bold mb-3">‚ûï Th√™m t√†i s·∫£n</h5>

    <input id="unitName" class="form-control mb-2" placeholder="T√™n t√†i s·∫£n">
    <input id="unitPrice" type="number" class="form-control mb-2" placeholder="Gi√° thu√™">
    <textarea id="unitDesc" class="form-control mb-3" placeholder="M√¥ t·∫£"></textarea>

    <button class="btn btn-primary" onclick="saveUnit()">L∆∞u</button>
  </div>

  <!-- ===== TABLE ===== -->
  <div class="card p-4">
    <h5 class="fw-bold mb-3">üì¶ Danh s√°ch t√†i s·∫£n</h5>

    <table class="table table-bordered">
      <thead>
        <tr>
          <th>ID</th>
          <th>T√™n</th>
          <th>Gi√°</th>
          <th>M√¥ t·∫£</th>
        </tr>
      </thead>
      <tbody id="unitTable"></tbody>
    </table>
  </div>

</div>

<!-- ================= SCRIPT ================= -->
<script>
/* ===== CONFIG ===== */
const API = "http://127.0.0.1:8000";
const TOKEN = localStorage.getItem("access_token");
const CURRENT_USER = JSON.parse(localStorage.getItem("currentUser"));

/* ===== B·∫¢O V·ªÜ ADMIN ===== */
if (!TOKEN || !CURRENT_USER || CURRENT_USER.role !== "admin") {
  alert("B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p admin");
  location.href = "login.html";
}

/* ===== BI·∫æN TO√ÄN C·ª§C ===== */
let PROPERTY_ID = null;

/* ===== L·∫§Y PROPERTY ===== */
async function initProperty() {
  const res = await fetch(`${API}/properties/`, {
    headers: { Authorization: "Bearer " + TOKEN }
  });

  const data = await res.json();

  if (!Array.isArray(data) || data.length === 0) {
    alert("‚ö†Ô∏è Ch∆∞a c√≥ property trong h·ªá th·ªëng.\nVui l√≤ng t·∫°o property tr∆∞·ªõc trong Swagger.");
    return;
  }

  PROPERTY_ID = data[0].id;
  console.log("PROPERTY_ID =", PROPERTY_ID);

  loadUnits();
}

/* ===== LOAD UNITS ===== */
async function loadUnits() {
  const res = await fetch(`${API}/units/`, {
    headers: { Authorization: "Bearer " + TOKEN }
  });

  const units = await res.json();
  const tbody = document.getElementById("unitTable");
  tbody.innerHTML = "";

  units.forEach(u => {
    tbody.innerHTML += `
      <tr>
        <td>${u.id}</td>
        <td>${u.name}</td>
        <td>${u.price}</td>
        <td>${u.description || ""}</td>
      </tr>
    `;
  });
}

/* ===== SAVE UNIT ===== */
async function saveUnit() {
  if (!PROPERTY_ID) {
    alert("PROPERTY_ID null ‚Äì ch∆∞a c√≥ property");
    return;
  }

  if (!unitName.value || !unitPrice.value) {
    alert("Vui l√≤ng nh·∫≠p ƒë·ªß t√™n v√† gi√°");
    return;
  }

  const payload = {
    property_id: PROPERTY_ID,
    name: unitName.value,
    price: Number(unitPrice.value),
    description: unitDesc.value
  };

  const res = await fetch(`${API}/units/`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      Authorization: "Bearer " + TOKEN
    },
    body: JSON.stringify(payload)
  });

  if (!res.ok) {
    alert("‚ùå L∆∞u th·∫•t b·∫°i");
    return;
  }

  alert("‚úÖ Th√™m t√†i s·∫£n th√†nh c√¥ng");
  unitName.value = "";
  unitPrice.value = "";
  unitDesc.value = "";

  loadUnits();
}

/* ===== INIT ===== */
initProperty();
</script>

</body>
</html>
